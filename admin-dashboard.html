<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CitySetu - Admin Dashboard</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Poppins', sans-serif; background:#f4f7f6 }
    .tab-btn { padding:1rem 1.5rem; font-weight:600; color:#6b7280; border-bottom:3px solid transparent }
    .tab-btn.active { color:#1B2A49; border-bottom-color:#FF7B00 }
    .table-wrapper,.section-wrapper { display:none }
    .btn-approve { background:#16a34a; color:#fff; padding:.3rem .6rem; border-radius:6px }
  </style>
</head>

<body>

<header class="bg-white shadow-md">
  <div class="container mx-auto px-6 py-4 flex justify-between">
    <h1 class="text-3xl font-bold text-[#1B2A49]">CitySetu Admin</h1>
    <button id="refresh-btn" class="bg-blue-600 text-white px-4 py-2 rounded">ðŸ”„ Refresh</button>
  </div>
</header>

<main class="container mx-auto px-6 py-8">

<!-- TABS -->
<div class="bg-white rounded shadow">
  <nav class="flex border-b">
    <button id="tab-workers" class="tab-btn active" onclick="admin.showTab('workers')">Manage Workers</button>
    <button class="tab-btn" onclick="admin.showTab('pending')">Pending Approvals</button>
  </nav>
</div>

<!-- MANAGE WORKERS -->
<div id="section-workers" class="section-wrapper mt-6 bg-white rounded shadow p-6">

  <h2 class="text-xl font-semibold mb-4">Add Worker</h2>

  <form id="add-worker-form" class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <input id="worker-name" class="border p-2" placeholder="Name" required />
    <input id="worker-phone" class="border p-2" placeholder="Phone" required />

    <select id="worker-service" class="border p-2" required>
      <option value="">Select Service</option>
    </select>

    <div class="md:col-span-3 text-right">
      <button class="bg-green-600 text-white px-4 py-2 rounded">Add Worker</button>
    </div>
  </form>

  <h2 class="text-xl font-semibold mt-8 mb-4">Approved Workers</h2>

  <table class="w-full border">
    <thead class="bg-gray-100">
      <tr>
        <th class="p-2">Name</th>
        <th class="p-2">Phone</th>
        <th class="p-2">Service</th>
      </tr>
    </thead>
    <tbody id="workers-table-body">
      <tr><td colspan="3" class="text-center p-4">Loading...</td></tr>
    </tbody>
  </table>

</div>

<!-- PENDING APPROVALS -->
<div id="table-pending" class="table-wrapper mt-6 bg-white rounded shadow p-6">
  <h2 class="text-xl font-semibold mb-4">Pending Approvals</h2>

  <table class="w-full border">
    <thead class="bg-gray-100">
      <tr>
        <th class="p-2">Name</th>
        <th class="p-2">Phone</th>
        <th class="p-2">Service</th>
        <th class="p-2">Action</th>
      </tr>
    </thead>
    <tbody id="pending-table-body">
      <tr><td colspan="4" class="text-center p-4">Loading...</td></tr>
    </tbody>
  </table>
</div>

</main>

<script>
const API = 'https://citysetu-api.onrender.com';
const ADMIN_TOKEN = sessionStorage.getItem('citysetu_admin_token');

if (!ADMIN_TOKEN) {
  alert('Login again');
  location.href = 'admin-login.html';
}

/* LOAD SERVICES */
async function loadServices() {
  const res = await fetch(`${API}/api/services`);
  const data = await res.json();
  const select = document.getElementById('worker-service');

  data.services.forEach(s => {
    const opt = document.createElement('option');
    opt.value = s.id;
    opt.textContent = s.name;
    select.appendChild(opt);
  });
}

/* ADMIN */
const admin = {

  showTab(tab) {
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.table-wrapper,.section-wrapper').forEach(s=>s.style.display='none');

    if (tab === 'workers') {
      document.getElementById('tab-workers').classList.add('active');
      document.getElementById('section-workers').style.display='block';
      this.fetchWorkers();
    }

    if (tab === 'pending') {
      document.querySelector("button[onclick=\"admin.showTab('pending')\"]").classList.add('active');
      document.getElementById('table-pending').style.display='block';
      this.fetchPending();
    }
  },

  async fetchWorkers() {
    const res = await fetch(`${API}/api/professionals/all`);
    const data = await res.json();
    const tbody = document.getElementById('workers-table-body');
    tbody.innerHTML = '';

    if (!data.workers.length) {
      tbody.innerHTML = `<tr><td colspan="3" class="p-4 text-center">No workers</td></tr>`;
      return;
    }

    data.workers.forEach(w => {
      tbody.innerHTML += `
        <tr>
          <td class="p-2">${w.name}</td>
          <td class="p-2">${w.phone}</td>
          <td class="p-2">${w.service}</td>
        </tr>`;
    });
  },

  async fetchPending() {
    const res = await fetch(`${API}/api/admin/pending`, {
      headers:{ Authorization:`Bearer ${ADMIN_TOKEN}` }
    });
    const data = await res.json();
    const tbody = document.getElementById('pending-table-body');
    tbody.innerHTML = '';

    if (!data.pending.length) {
      tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center">No pending approvals</td></tr>`;
      return;
    }

    data.pending.forEach(p => {
      tbody.innerHTML += `
        <tr>
          <td class="p-2">${p.name}</td>
          <td class="p-2">${p.phone}</td>
          <td class="p-2">${p.service}</td>
          <td class="p-2">
            <button class="btn-approve" onclick="admin.approve('${p.id}')">Approve</button>
          </td>
        </tr>`;
    });
  },

  async approve(id) {
    await fetch(`${API}/api/admin/approve/${id}`, {
      method:'PUT',
      headers:{ Authorization:`Bearer ${ADMIN_TOKEN}` }
    });
    alert('Approved');
    this.fetchPending();
    this.fetchWorkers();
  },

  async addWorker(e) {
    e.preventDefault();
    const name = worker-name.value;
    const phone = worker-phone.value;
    const serviceId = worker-service.value;

    await fetch(`${API}/api/professionals/signup`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ name, phone, serviceIds:[Number(serviceId)] })
    });

    alert('Submitted for approval');
    e.target.reset();
  },

  init() {
    document.getElementById('add-worker-form').addEventListener('submit', this.addWorker);
    loadServices();
    this.showTab('workers');
  }
};

window.admin = admin;
document.addEventListener('DOMContentLoaded', ()=>admin.init());
</script>

</body>
</html>
