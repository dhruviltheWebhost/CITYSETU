<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CitySetu Admin Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
:root {
  --brand-navy:#1B2A49;
  --brand-orange:#FF7B00;
}
body{font-family:Poppins,sans-serif;background:#f4f7f6}
.tab-btn{padding:1rem 1.5rem;font-weight:600;color:#6b7280;border-bottom:3px solid transparent}
.tab-btn.active{color:var(--brand-navy);border-bottom-color:var(--brand-orange)}
.section{display:none}
.section.active{display:block}
.form-input{width:100%;border:1px solid #d1d5db;border-radius:6px;padding:8px}
.btn-approve{background:#16a34a;color:white;padding:6px 10px;border-radius:6px}
.btn-reject{background:#dc2626;color:white;padding:6px 10px;border-radius:6px}
</style>
</head>

<body>

<header class="bg-white shadow p-4 flex justify-between items-center">
  <h1 class="text-2xl font-bold text-[var(--brand-navy)]">
    CitySetu <span class="font-light">Admin</span>
  </h1>
  <button id="refreshBtn" class="bg-blue-600 text-white px-4 py-2 rounded">
    Refresh
  </button>
</header>

<main class="max-w-7xl mx-auto mt-6 bg-white shadow rounded">

<!-- TABS -->
<nav class="flex border-b">
  <button class="tab-btn active" onclick="admin.showTab('workers')">Workers</button>
  <button class="tab-btn" onclick="admin.showTab('pending')">Pending</button>
  <button class="tab-btn" onclick="admin.showTab('chatqa')">Chat Q&A</button>
</nav>

<!-- WORKERS -->
<section id="workers" class="section active p-6">
<h2 class="text-xl font-semibold mb-4">Approved Workers</h2>

<table class="w-full border">
<thead class="bg-gray-100">
<tr>
<th class="p-2">Name</th>
<th class="p-2">Phone</th>
<th class="p-2">Service</th>
</tr>
</thead>
<tbody id="workersBody">
<tr><td colspan="3" class="text-center p-4">Loading...</td></tr>
</tbody>
</table>

<hr class="my-6">

<h3 class="text-lg font-semibold mb-2">Add Worker</h3>
<form id="addWorkerForm" class="grid md:grid-cols-3 gap-4">
<input id="wName" class="form-input" placeholder="Name" required>
<input id="wPhone" class="form-input" placeholder="Phone" required>
<select id="wService" class="form-input"></select>
<button class="bg-green-600 text-white px-4 py-2 rounded md:col-span-3">
Add Worker
</button>
</form>
</section>

<!-- PENDING -->
<section id="pending" class="section p-6">
<h2 class="text-xl font-semibold mb-4">Pending Approvals</h2>

<table class="w-full border">
<thead class="bg-gray-100">
<tr>
<th class="p-2">Name</th>
<th class="p-2">Phone</th>
<th class="p-2">Service</th>
<th class="p-2">Action</th>
</tr>
</thead>
<tbody id="pendingBody">
<tr><td colspan="4" class="text-center p-4">Loading...</td></tr>
</tbody>
</table>
</section>

<!-- CHAT QA -->
<section id="chatqa" class="section p-6">
<h2 class="text-xl font-semibold mb-4">Chat Q&A</h2>

<form id="qaForm" class="grid md:grid-cols-2 gap-4 mb-6">
<input id="qaQuestion" class="form-input" placeholder="Question" required>
<input id="qaAnswer" class="form-input" placeholder="Answer" required>
<button class="bg-green-600 text-white px-4 py-2 rounded md:col-span-2">
Add Q&A
</button>
</form>

<table class="w-full border">
<thead class="bg-gray-100">
<tr>
<th class="p-2">Question</th>
<th class="p-2">Answer</th>
<th class="p-2">Status</th>
<th class="p-2">Action</th>
</tr>
</thead>
<tbody id="qaBody"></tbody>
</table>
</section>

</main>

<script>
const API='https://citysetu-api.onrender.com';
const TOKEN=sessionStorage.getItem('citysetu_admin_token');
if(!TOKEN){alert('Login required');location='admin-login.html'}

const admin={

showTab(tab) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.table-wrapper, .section-wrapper')
    .forEach(s => s.style.display = 'none');

  if (tab === 'workers') {
    document.getElementById('tab-workers').classList.add('active');
    document.getElementById('section-workers').style.display = 'block';
    this.fetchData();
  }

  if (tab === 'pending') {
    document.querySelector('[onclick="admin.showTab(\'pending\')"]').classList.add('active');
    document.getElementById('table-pending').style.display = 'block';
    this.fetchPending();
  }

  if (tab === 'chatqa') {
    document.querySelector('[onclick="admin.showTab(\'chatqa\')"]').classList.add('active');
    document.getElementById('section-chatqa').style.display = 'block';
    this.fetchChatQA();
  }
},
  async fetchChatQA() {
  const tbody = document.getElementById('chatqa-table');
  tbody.innerHTML = '<tr><td colspan="4">Loading...</td></tr>';

  try {
    const res = await fetch(`${RENDER_API_URL}/api/chat/questions`);
    const data = await res.json();
    tbody.innerHTML = '';

    data.questions.forEach(q => {
      tbody.innerHTML += `
        <tr>
          <td>${q.question}</td>
          <td>${q.answer || '-'}</td>
          <td>
            <span class="${q.active ? 'text-green-600' : 'text-red-600'}">
              ${q.active ? 'Enabled' : 'Disabled'}
            </span>
          </td>
          <td>
            <button
              class="${q.active ? 'btn-reject' : 'btn-approve'}"
              onclick="admin.toggleChatQA(${q.id}, ${q.active})">
              ${q.active ? 'Disable' : 'Enable'}
            </button>
          </td>
        </tr>
      `;
    });

  } catch (err) {
    tbody.innerHTML = `<tr><td colspan="4">Failed to load</td></tr>`;
  }
},
  async toggleChatQA(id, isActive) {
  try {
    await fetch(`${RENDER_API_URL}/api/admin/chat/${id}`, {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${ADMIN_TOKEN}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        active: !isActive
      })
    });

    this.fetchChatQA();
  } catch (err) {
    alert('Failed to update Q&A');
  }
},

async loadWorkers(){
const res=await fetch(`${API}/api/professionals/all`);
const data=await res.json();
const tbody=document.getElementById('workersBody');
tbody.innerHTML='';
data.professionals.forEach(w=>{
tbody.innerHTML+=`<tr>
<td class="p-2">${w.name}</td>
<td class="p-2">${w.phone}</td>
<td class="p-2">${w.service}</td>
</tr>`;
});
},

async loadPending(){
const res=await fetch(`${API}/api/admin/pending`,{
headers:{Authorization:`Bearer ${TOKEN}`}
});
const data=await res.json();
const tbody=document.getElementById('pendingBody');
tbody.innerHTML='';
data.pending.forEach(p=>{
tbody.innerHTML+=`<tr>
<td class="p-2">${p.name}</td>
<td class="p-2">${p.phone}</td>
<td class="p-2">${p.service}</td>
<td class="p-2">
<button class="btn-approve" onclick="admin.approve('${p.id}')">Approve</button>
</td>
</tr>`;
});
},

async approve(id){
await fetch(`${API}/api/admin/approve/${id}`,{
method:'PUT',
headers:{Authorization:`Bearer ${TOKEN}`}
});
this.loadPending();
this.loadWorkers();
},

async loadServices(){
const res=await fetch(`${API}/api/services`);
const data=await res.json();
const sel=document.getElementById('wService');
sel.innerHTML='';
data.services.forEach(s=>{
sel.innerHTML+=`<option value="${s.id}">${s.name}</option>`;
});
},

async addWorker(e){
e.preventDefault();
await fetch(`${API}/api/professionals/signup`,{
method:'POST',
headers:{'Content-Type':'application/json'},
body:JSON.stringify({
name:wName.value,
phone:wPhone.value,
serviceIds:[wService.value]
})
});
e.target.reset();
this.loadWorkers();
},

async loadQA(){
const res=await fetch(`${API}/api/chat/questions`);
const data=await res.json();
const tbody=document.getElementById('qaBody');
tbody.innerHTML='';
data.questions.forEach(q=>{
tbody.innerHTML+=`<tr>
<td class="p-2">${q.question}</td>
<td class="p-2">${q.answer}</td>
<td class="p-2">${q.active?'Active':'Disabled'}</td>
<td class="p-2">
<button class="btn-reject" onclick="admin.disableQA(${q.id})">Disable</button>
</td>
</tr>`;
});
},

async addQA(e){
e.preventDefault();
await fetch(`${API}/api/admin/chat/questions`,{
method:'POST',
headers:{
Authorization:`Bearer ${TOKEN}`,
'Content-Type':'application/json'
},
body:JSON.stringify({
question:qaQuestion.value,
answer:qaAnswer.value
})
});
e.target.reset();
this.loadQA();
},

async disableQA(id){
await fetch(`${API}/api/admin/chat/question/${id}`,{
method:'DELETE',
headers:{Authorization:`Bearer ${TOKEN}`}
});
this.loadQA();
}

};

refreshBtn.onclick=()=>admin.loadWorkers();
addWorkerForm.onsubmit=e=>admin.addWorker(e);
qaForm.onsubmit=e=>admin.addQA(e);

document.addEventListener('DOMContentLoaded', () => {
  loadServices();
  admin.init();

  // âœ… CHAT Q&A FORM SUBMIT HANDLER (ADD HERE)
  const chatQAForm = document.getElementById('chatqa-form');

  if (chatQAForm) {
    chatQAForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const question = document.getElementById('qa-question').value.trim();
      const answer = document.getElementById('qa-answer').value.trim();

      if (!question || !answer) {
        alert('Question & Answer required');
        return;
      }

      try {
        await fetch(`${RENDER_API_URL}/api/admin/chat/questions`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${ADMIN_TOKEN}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ question, answer })
        });

        document.getElementById('qa-question').value = '';
        document.getElementById('qa-answer').value = '';

        admin.fetchChatQA(); // refresh table
      } catch (err) {
        alert('Failed to add Q&A');
        console.error(err);
      }
    });
  }
});
</script>

</body>
</html>
